<%= link_to l(:button_back), (request.referer || { action: 'show', id: @page.title, project_id: @page.project }) %>

<fieldset id="default_permissions" class="box">
  <legend>Standardberechtigung</legend>

  <%= form_with url: { controller: 'wiki', action: 'update_wiki_page_user_permissions', id: @page.title, project_id: @page.project }, method: :patch, local: true do %>
    <label for="default-permission-select">Standardzugriff</label>
    <select id="default-permission-select" name="wiki_page_default_permission[level]">
      <option value="-1" <%= 'selected' if @page.default_permission.nil? %>>Keine Standardregel (wie bisher)</option>
      <option value="0" <%= 'selected' if @page.default_permission&.level == 0 %>>Zugriff gesperrt</option>
      <option value="1" <%= 'selected' if @page.default_permission&.level == 1 %>>Kann einsehen</option>
      <option value="2" <%= 'selected' if @page.default_permission&.level == 2 %>>Kann bearbeiten</option>
      <option value="3" <%= 'selected' if @page.default_permission&.level == 3 %>>Kann Berechtigungen setzen</option>
    </select>

    <br/>

    <input type="submit" value="Speichern">
  <% end %>
</fieldset>

<% if @page.members_without_permissions.size != 0 %>
  <fieldset id="add_private_permissions" class="box">
    <legend>Individuelle Benutzerberechtigung hinzufügen</legend>

    <%= form_with url: { controller: 'wiki', action: 'create_wiki_page_user_permissions', id: @page.title, project_id: @page.project }, method: :post, local: true do %>
      <label for="user-select">Benutzer auswählen</label>
      <select id="user-select" name="wiki_page_user_permission[member_id]">
        <% @page.members_without_permissions.each do |member| %>
          <option value="<%= member.id %>"><%= member.name%></option>
        <% end %>
      </select>

      <br/><%= hidden_field_tag 'wiki_page_user_permission[wiki_page_id]', @page.id %>

      <label for="permission-select">Berechtigung auswählen</label>
      <select id="permission-select" name="wiki_page_user_permission[level]">
        <option value="0">Zugriff gesperrt</option>
        <option value="1">Kann einsehen</option>
        <option value="2">Kann bearbeiten</option>
        <option value="3">Kann Berechtigungen setzen</option>
      </select>

      <br/>

      <input type="submit" value="Speichern">
    <% end %>
  </fieldset>
<% end -%>

<% if @wiki_page_user_permissions.size != 0 %>
  <fieldset id="default_permissions" class="box">
    <legend>Bestehende Berechtigungen</legend>
      <%= form_with url: { controller: 'wiki', action: 'update_wiki_page_user_permissions', id: @page.title, project_id: @page.project }, method: :patch, local: true do %>

      <table class="list">
        <thead>
	        <th><%= l(:label_user) %></th>
	        <th><%= l(:label_role) %></th>

          <%= call_hook(:view_projects_settings_members_table_header, :project => @project) %>
	      </thead>
	      <tbody>

          <% @wiki_page_user_permissions.each do |perm| %>
            <tr class="<%= cycle 'odd', 'even' %>">
              <td>
                <%= perm.user.name %>
              </td>
              <td align="center">
                <table class="edit_permissions_table">
                  <thead>
                    <tr>
                      <th>Zugriff gesperrt</th>
                      <th>Kann einsehen</th>
                      <th>Kann bearbeiten</th>
    		              <th>Kann Berechtigungen setzen</th>
    	              </tr>
                  </thead>
                  <tbody>
    	              <tr>
    	                <% for i in 0..3 do %>
    	                  <td align="center"><%= radio_button_tag("wiki_page_user_permission[#{perm.id}]", i, i == perm.level)%></td>
    		              <% end %>
    	              </tr>
                  </tbody>
                </table>
              </td>
              <td align="center">
                <%= link_to(l(:button_delete), { action: 'destroy_wiki_page_user_permissions', id: @page.title, project_id: @page.project, permission_id: perm.id }, method: :delete, class: 'icon icon-del') %>
              </td>

              <%= call_hook(:view_projects_settings_members_table_row, { :project => @project, :member => perm}) %>
            </tr>
          <% end; reset_cycle %>
        </tbody>
      </table>

      <input id="save-permissions" type="submit" value="Speichern">
    </fieldset>
  <% end %>
<% else %>
  <p class="nodata"><%= l(:label_no_data) %></p>
<% end %>
